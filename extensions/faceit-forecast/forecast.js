function println(...e){console.log(log_prefix,"color: white; background-color: black;","color: orange; font-weight: bold; background-color: black;","color: white; font-weight: bold; background-color: black;","color: white; background-color: black;",e.join(" "))}function error(e,a){console.error(log_prefix,"color: white; background-color: black;","color: orange; font-weight: bold; background-color: black;","color: white; font-weight: bold; background-color: black;","color: white; background-color: black;",e||a?.message,a?.stack)}function setupBrandIcon(e,a=28,s=28){e.querySelectorAll(".brand-icon").forEach(e=>{let n=getHtmlResource("src/visual/icons/rawlogo.svg").cloneNode(!0);e.appendChild(n),e.style.width=`${a}px`,e.style.height=`${s}px`,e.style.position="absolute",e.style.right="8px",e.style.top="8px"})}function hideNode(e){e.style.display="none",e.setAttribute("hided","true")}function hideWithCSS(e){let a=document.getElementById("hideStyleElement");a||(a=document.createElement("style"),a.id="hideStyleElement",document.head.appendChild(a));const s=a.sheet;Array.from(s.cssRules||[]).some(a=>a.selectorText===e)||s.insertRule(`${e} { display: none; }`,s.cssRules?.length)}function appendTo(e,a){a.after(e)}function appendToAndHide(e,a){appendTo(e,a),hideNode(a)}function preppendTo(e,a){a.prepend(e)}function preppendToAndHide(e,a){preppendTo(e,a),hideNode(a)}function isNumber(e){return/^-?\d+(\.\d+)?$/.test(e)}function chunkArray(e,a){const s=[];for(let n=0;n<e.length;n+=a)s.push(e.slice(n,n+a));return s}function getNthParent(e,a){for(;e&&a--;)e=e.parentElement;return e}async function getSettingValue(e,a){return new Promise((s,n)=>{CLIENT_STORAGE.get([e],r=>{const o=CLIENT_RUNTIME.lastError;if(o)n(new Error(o));else{const n=void 0===r[e]?a:r[e];s(n)}})})}async function setSettingValue(e,a){return new Promise((s,n)=>{CLIENT_STORAGE.set({[e]:a},()=>{const e=CLIENT_RUNTIME.lastError;e?n(new Error(e)):s(a)})})}function parseNumber(e,a=!1){if(!e)return NaN;const s=e.replace(/[^\d.,-]/g,"").replace(",",".");return a?Number.parseFloat(s):Number.parseInt(s,10)}function createColoredSpan(e,a,s=!1){const n=document.createElement("span");return n.style.color=s||null==e||null==a?white:a?green:red,n.textContent=e??"-",n}function createCompositeCell(e){const a=document.createElement("div");return Object.assign(a.style,{display:"flex",alignItems:"center",gap:"2px",flexDirection:"row",justifyContent:"flex-start",flex:"1 1 0%"}),e.forEach(({text:e,condition:s,isSlash:n})=>a.appendChild(createColoredSpan(e,s,n))),a}function replaceNodeWithColored(e,a,s){if(!e)return;const n=createColoredSpan(a,s);n.className=e.className,e.replaceWith(n)}async function isSettingEnabled(e,a){const s=await CLIENT_STORAGE.get([e]);return void 0===s[e]?(await CLIENT_STORAGE.set({[e]:a}),a):s[e]}async function getSettings(e){const a=Object.keys(e),s=await CLIENT_STORAGE.get(a),n={},r={};return a.forEach(a=>{void 0===s[a]?(n[a]=e[a],r[a]=e[a]):n[a]=s[a]}),Object.keys(r).length>0&&await CLIENT_STORAGE.set(r),n}async function isExtensionEnabled(){return await isSettingEnabled("isEnabled",!0)}function setGradientColor(e,a){const s=(a=Math.min(Math.max(a,0),100))/100,n=["#ff0022","#fbec1e","#32d35a"];e.style.color=s<.5?interpolateColor(n[0],n[1],2*s):interpolateColor(n[1],n[2],2*(s-.5))}function interpolateColor(e,a,s){const[n,r,o]=[e.slice(1,3),e.slice(3,5),e.slice(5,7)].map(e=>Number.parseInt(e,16)),[l,i,c]=[a.slice(1,3),a.slice(3,5),a.slice(5,7)].map(e=>Number.parseInt(e,16)),[d,u,p]=[n+(l-n)*s,r+(i-r)*s,o+(c-o)*s].map(e=>Math.round(e).toString(16).padStart(2,"0"));return`#${d}${u}${p}`}function defineLobby(e){for(const a of pageTypes)if(a.test(e)){const s=a.extract(e);return new Lobby(a.name,s)}return null}async function fetchInternal(e,a,s="application/json, text/plain, */*"){const n=await fetch(e,{headers:{accept:s,"accept-language":"ru,en-US;q=0.9,en;q=0.8","faceit-referer":"web-next","sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin"},credentials:"include"});if(!n.ok){const e=await n.text();error(`${a}: ${n.status} ${n.statusText}. Response: ${e}`)}return n.json()}async function fetchV4(e,a){const s=await getApiKey(),n=await fetch(e,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"},credentials:"include"});return n.ok||error(`${a}: ${n.statusText}`),n.json()}async function fetchCached(e,a,s,n){return e.get(a)||e.set(a,await n(a,s)).get(a)}async function fetchMatchStats(e){return fetchV4Cached(matchDataCache,`${baseUrlV4}/matches/${e}`,`Error when retrieving match statistics by ID ${e}`)}async function fetchMatchStatsDetailed(e){return fetchV4Cached(matchDataStatsCache,`${baseUrlV4}/matches/${e}/stats`,`Error when retrieving detailed match statistics by ID: ${e}`)}async function fetchPlayerInGameStats(e,a,s=30,n=0,r=0){return fetchV4Cached(playerGamesDataCache,`${baseUrlV4}/players/${e}/games/${a}/stats?limit=${s}${0===n?"":`&to=${n}`}${0===r?"":`&from=${n}`}`,`Error when requesting player game data by ID: ${e}`)}async function fetchPlayerStatsById(e){return fetchV4Cached(playerDataCache,`${baseUrlV4}/players/${e}`,`Error when requesting player data by ID: ${e}`)}async function fetchPlayerStatsByNickName(e){return fetchV4Cached(playerDataCache,`${baseUrlV4}/players?nickname=${encodeURIComponent(e)}`,`Error when requesting player data by nickname: ${e}`)}async function fetchV1MatchRoundStats(e,a,s=30,n="5v5",r){return fetchV1Cached(matchDataV1Cache,`${baseUrlV1}/${e}/games/${a}?size=${s}&game_mode=${n}&to=${r}`,`Error when retrieving V1 match round statistics by ID: ${e}`)}async function fetchV2MatchStats(e){return fetchV2Cached(matchDataV2Cache,`${baseUrlV2}/match/${e}`,`Error when retrieving V2 match statistics by ID: ${e}`)}async function fetchV3MatchStats(e){return fetchV3Cached(matchDataV3Cache,`${baseUrlV3}/matches/${e}`,`Error when retrieving V3 match statistics by ID: ${e}`)}function extractPlayerNick(){const e=/players\/([a-zA-Z0-9-_.]+)/.exec(window.location.href);return e?e[1]:null}function extractGameType(e=null){const a=[/stats\/([a-zA-Z0-9-_]+)/,/\/([a-zA-Z0-9-_]+)\/room/,/\/players\/[^/]+\/([a-zA-Z0-9-_]+)/];for(const e of a){const a=e.exec(window.location.href);if(a)return a[1]}return e}function extractMatchId(){const e=/room\/([a-z0-9-]+)/i.exec(window.location.href);return e?e[1]:null}function extractLanguage(){const e=window.location.href,a=/https:\/\/www\.faceit\.com\/([^/]+)\/?/.exec(e);return a?a[1]:null}async function getApiKey(){let e=getCookie("forecast-api-key");if(!e){const a=await fetch("https://raw.githubusercontent.com/Faceit-Forecast/Forecast/refs/heads/master/api-key");e=await a.text(),setCookie("forecast-api-key",e,5)}return e}function setCookie(e,a,s){const n=new Date;n.setTime(n.getTime()+60*s*1e3);const r="expires="+n.toUTCString();document.cookie=e+"="+encodeURIComponent(a)+";"+r+";path=/;domain=.faceit.com;secure"}function getCookie(e){const a=e+"=",s=document.cookie.split(";");for(const e of s){let s=e.trim();if(s.startsWith(a))return decodeURIComponent(s.substring(a.length))}return null}async function getDeviceId(){return cachedDeviceId||new Promise(e=>{CLIENT_API.storage.local.get(["deviceId"],async a=>{if(a.deviceId)cachedDeviceId=a.deviceId,e(a.deviceId);else{const a=await registerDevice();a&&(cachedDeviceId=a,CLIENT_API.storage.local.set({deviceId:a})),e(a)}})})}async function registerDevice(){try{const e=await fetch(`${baseUrlFC}/v2/extension/register`,{method:"POST",headers:{"Content-Type":"application/json","X-Extension-Version":EXTENSION_VERSION},body:JSON.stringify({})});return e.ok&&(await e.json()).deviceId||null}catch(e){return error("Failed to register device:",e),null}}async function fetchFC(e,a={}){try{const s=await getDeviceId(),n=a.headers||{};s&&(n["X-Device-ID"]=s),n["X-Extension-Version"]=EXTENSION_VERSION;const r=await fetch(e,{...a,headers:n});if(!r.ok)return 204!==r.status&&error(`Request failed: ${r.statusText}`),null;const o=await r.text();return o?JSON.parse(o):null}catch(e){return error(`Request error: ${e.message}`),null}}async function fetchPing(){await fetchFC(`${baseUrlFC}/v2/extension/ping`)}function sanitizeHtml(e){const a=document.createElement("div");return a.innerHTML=e,a.querySelectorAll("script").forEach(e=>e.remove()),a.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(a=>{(a.name.startsWith("on")||"href"===a.name&&a.value.toLowerCase().startsWith("javascript:"))&&e.removeAttribute(a.name)})}),a.innerHTML}function isValidUrl(e){try{const a=new URL(e);return"http:"===a.protocol||"https:"===a.protocol}catch{return!1}}async function fetchBannerData(e,a){const s=getCookie(`forecast-banner-cache-${e}-${a}`);if(s)try{const n=JSON.parse(s);return sendBannerMetric(n.bannerId,e,a),n}catch(e){error("Failed to parse cached banner data:",e)}const n=await fetchFC(`${baseUrlFC}/v2/integrations/banner?lang=${e}&slot=${a}`);return n&&setCookie("forecast-banner-cache",JSON.stringify(n),5),n}async function sendBannerMetric(e,a,s){await fetchFC(`${baseUrlFC}/v2/integrations/banner?metricOnly=true&bannerId=${e}&lang=${a}&slot=${s}`)}async function loadAllHTMLs(){const e=[];htmlUrls.forEach(a=>{e.push(getHTMLCodeFromFile(a).then(e=>{htmls.set(a,e)}))}),await Promise.all(e)}async function loadSVGDataURIs(){const e=logoSVGUrls.map(async e=>{const a=await getSVGText(e),s=`data:image/svg+xml,${encodeURIComponent(a)}`;svgDataURIs.set(e,s)});await Promise.all(e)}async function getSVGText(e){let a=CLIENT_RUNTIME.getURL(e);const s=await fetch(a);return s.ok?await s.text():(error(`HTTP error! Status: ${s.status}`),null)}function getSVGDataURI(e){return svgDataURIs.get(e)}async function loadLevelIcons(){if(20!==levelIcons.size)for(let e=1;e<=20;e++){let a=getHtmlResource(`src/visual/tables/levels/level${e}.html`);levelIcons.set(e,a)}}function getHtmlResource(e){return htmls.get(e)}function getLevelIcon(e){return levelIcons.get(e).cloneNode(!0)}function setupStyles(){let e=getHtmlResource("src/visual/tables/forecaststyles.css"),a=document.getElementById("forecast-styles");a||(a=document.createElement("style"),a.id="forecast-styles",document.head.appendChild(a)),a.textContent="";const s=document.createTextNode(e.textContent);a.appendChild(s)}async function getHTMLCodeFromFile(e){let a=CLIENT_RUNTIME.getURL(e);const s=await fetch(a);if(!s.ok)return error(`HTTP error! Status: ${s.status}`),null;const n=await s.text(),r=parser.parseFromString(n,"text/html"),o=document.createElement("div");for(;r.body.firstChild;)o.appendChild(r.body.firstChild);return o}async function initI18nLanguage(){try{const e=await getSettingValue("language",null);i18nCurrentLanguage=e&&I18N_SUPPORTED_LANGUAGES.includes(e)?e:detectI18nBrowserLanguage()}catch(e){i18nCurrentLanguage=detectI18nBrowserLanguage()}}function detectI18nBrowserLanguage(){const e=navigator.language?.split("-")[0]||navigator.userLanguage?.split("-")[0];return I18N_SUPPORTED_LANGUAGES.includes(e)?e:"en"}async function loadTranslations(e){try{const a=CLIENT_RUNTIME.getURL(`_locales/${e}/forecast.json`),s=await fetch(a);s.ok&&(i18nTranslations[e]=await s.json())}catch(a){error("Failed to load translations for "+e,a)}if("en"!==e&&!i18nTranslations.en)try{const e=CLIENT_RUNTIME.getURL("_locales/en/forecast.json"),a=await fetch(e);a.ok&&(i18nTranslations.en=await a.json())}catch(e){error("Failed to load fallback translations",e)}}function t(e,a=null){if(!isI18nLoaded)return println(`i18n: t() called before i18n loaded, key=${e}`),null!==a?a:e;const s=i18nTranslations[i18nCurrentLanguage],n=s?.[e];if(void 0!==n)return n;if("en"!==i18nCurrentLanguage){const a=i18nTranslations.en?.[e];if(void 0!==a)return a}return null!==a?a:e}function localizeHtmlResource(e){e&&(e.querySelectorAll("[data-i18n]").forEach(e=>{const a=e.getAttribute("data-i18n"),s=t(a,null);s&&s!==a&&(e.textContent=s)}),e.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const a=e.getAttribute("data-i18n-placeholder"),s=t(a,null);s&&s!==a&&(e.placeholder=s)}))}async function setupPlayerCardMatchData(e,a,s){let n=`session-${matchRoomModule.sessionId}-player-table-${e}`;if(s.querySelector("[class~=tableId]"))return null;let r=getHtmlResource("src/visual/tables/player.html").cloneNode(!0);r.querySelector("[class=player-name]").textContent=t("player_stats","Player Stats"),setupBrandIcon(r,24,24),appendTo(r,s);let o=r.querySelector("[class~=player-table]");return o.classList.add(n),o}function calculateTeamMatches(e){const a={};return e.forEach(({maps:e})=>{e.forEach((e,s)=>{a[s]||(a[s]={wins:0,totalGames:0}),a[s].wins+=e.wins,a[s].totalGames+=e.totalGames})}),a}function displayTeamMatches(e,a,s){const n=a.split("$").pop(),r=a.split("$")[0];addTableTeamTitle(e,n,r),Object.entries(s).sort(([,e],[,a])=>a.wins/a.totalGames-e.wins/e.totalGames).forEach(([a,s])=>{const r=(s.wins/s.totalGames*100).toFixed(0);addRow(e.querySelector(`[class~="${n}"]`),a,s.totalGames,r)})}function displayPlayerStats(e,a,s){const{maps:n}=a;Array.from(n.entries()).sort(([,{wins:e,totalGames:a}],[,{wins:s,totalGames:n}])=>s/n-e/a).forEach(([e,{totalGames:a,wins:n}])=>{const r=(n/a*100).toFixed(0);addRow(s,e,a,r)})}async function getMatchWinRates(e){if(!e)return void error("Match ID is not provided!");const a=await fetchMatchStats(e);a?await displayWinRates(a):error("Error when retrieving match statistics: Incorrect match structure.")}async function findUserCard(e,a){let s="div[class*=styles__PopoverStyled] > div[class*=styles__FixedContainer] > div[class*=styles__NameContainer] > a > h5";await matchRoomModule.doAfterNodeAppearWithCondition(s,a=>a.innerText===e,e=>{let s=e.parentElement.parentElement.parentElement.parentElement.querySelector("div[class*=styles__ScrollableContainer] > div[class*=RatingsAndStats__Container]");matchRoomModule.isProcessedNode(s)||(matchRoomModule.processedNode(s),a(s))},`${s}-${e}`)}async function calculateStats(e,a,s){let n=extractGameType("cs2"),r=await fetchPlayerInGameStats(a,n,s),o=(await fetchPlayerStatsById(a)).nickname;if(!r.items||0===r.items.length)return;matchRoomModule.teamCache.has(e)||matchRoomModule.teamCache.set(e,new Map);const l=matchRoomModule.teamCache.get(e);r.items.forEach(e=>{const s=e.stats;if("5v5"!==s["Game Mode"])return;const n=s.Map,r=Number.parseInt(s.Result);l.has(a)||l.set(a,{nickname:s.Nickname,maps:new Map});const o=l.get(a).maps;o.has(n)||o.set(n,{wins:0,totalGames:0});const i=o.get(n);i.wins+=r,i.totalGames+=1}),await findUserCard(o,async e=>{let s=await setupPlayerCardMatchData(a,o,e);if(!s)return;const n=l.get(a);n&&displayPlayerStats(a,n,s)})}async function displayWinRates(e){const a=e.teams.faction1,s=e.teams.faction2,n=await getSettingValue("sliderValue",30),r=a.roster.map(e=>calculateStats(`${a.name}$roster1`,e.player_id,n)),o=s.roster.map(e=>calculateStats(`${s.name}$roster2`,e.player_id,n));await Promise.all([...r,...o]);let l=`team-table-${matchRoomModule.sessionId}`;await matchRoomModule.doAfterAllNodeAppear('[name="info"][class*=Overview__Column]',async e=>{let a=e.querySelector("[class*=team-table]");if(a){if(a.classList.contains(l))return;a.remove()}const s=e.matches('[name="info"]')?e:e.querySelector('[name="info"][class*=Overview__Column]');if(!s)return!1;if(matchRoomModule.isProcessedNode(s))return!1;matchRoomModule.processedNode(s);let n=s.querySelector("[class*=Overview__Stack]"),r=getHtmlResource("src/visual/tables/team.html").cloneNode(!0);setupBrandIcon(r,24,24),e.style.overflowBlock="unset",r.classList.add(l),n.after(r),matchRoomModule.teamCache.forEach((e,a)=>{const s=calculateTeamMatches(e);displayTeamMatches(r,a,s)})})}function addTableTeamTitle(e,a,s){e.querySelector(`[class*=${a}-name]`).textContent=s}function addRow(e,a,s,n){const r=e.insertRow(),o=r.insertCell(0),l=r.insertCell(1),i=r.insertCell(2);o.innerHTML=a.replace("de_","").replace(/(\d)/g," $1").toLocaleUpperCase(),l.innerHTML=s,i.innerHTML=n+"%",setGradientColor(i,n)}function tryCleanCache(){let e=Number.parseInt(getCookie(cookieCacheId),10),a=Date.now();(!e||e>a)&&(setCookie(cookieCacheId,a+864e5,1440),cleanCache())}async function initDB(){return new Promise((e,a)=>{const s=indexedDB.open(DB_NAME,1);s.onerror=()=>a(s.error),s.onsuccess=()=>{db=s.result,e(db)},s.onupgradeneeded=e=>{const a=e.target.result;if(!a.objectStoreNames.contains("matches")){const e=a.createObjectStore("matches",{keyPath:"matchId"});e.createIndex("cacheDate","cacheDate"),e.createIndex("lastUsed","lastUsed"),e.createIndex("version","version")}}})}async function loadMatchHistoryCache(){return db||await initDB(),new Promise((e,a)=>{const s=db.transaction("matches","readonly").objectStore("matches").getAll();s.onsuccess=()=>{s.result.forEach(e=>{5===e.version&&cacheMap.set(`${forecastCacheKeyPrefix}::${e.matchId}`,e)}),e()},s.onerror=()=>a(s.error)})}function calculatePerformanceRating(e,a,s=null,n=null){const r=parseInt(e.Kills)||0,o=parseInt(e.Assists)||0,l=parseInt(e.Deaths)||0,i=parseFloat(e.ADR)||0,c=parseFloat(e["K/D Ratio"])||0,d=parseInt(e["First Kills"])||0,u=parseInt(e["Entry Count"])||0,p=parseInt(e["Entry Wins"])||0,h=parseFloat(e["Match Entry Rate"])||0,m=parseFloat(e["Match Entry Success Rate"])||0,y=parseInt(e["Clutch Kills"])||0,f=parseInt(e["1v1Wins"])||0,g=parseInt(e["1v1Count"])||0,v=parseInt(e["1v2Wins"])||0,w=parseInt(e["1v2Count"])||0,b=parseInt(e["Double Kills"])||0,S=parseInt(e["Triple Kills"])||0,E=parseInt(e["Quadro Kills"])||0,C=parseInt(e["Penta Kills"])||0,x=parseFloat(e["Utility Damage"])||0,A=parseInt(e["Utility Count"])||0,N=parseInt(e["Utility Successes"])||0,I=parseInt(e["Flash Count"])||0,M=parseInt(e["Flash Successes"])||0,_=parseInt(e["Enemies Flashed"])||0,T=parseInt(e.MVPs)||0,L=a,R=r/L,P=o/L,k=l/L,$=(.35*Math.min(Math.pow(R/.75,1.1),1)+.4*Math.pow(Math.min(Math.max(c,.3)/1.1,1.3),1.3)+.25*Math.pow(Math.min(i/85,1.2),1.15))*(k>.7?Math.pow(Math.max(.4,1-1.2*(k-.7)),1.1):1)*(1+Math.min((.03*b+.1*S+.25*E+.5*C)/L,.2))*100,F=d/L,D=g>0?f/g:0,q=w>0?v/w:0,H=100*(.4*Math.min(Math.pow(F/.25,1.1),1)+.35*(u>0?.25*h+.45*m+.3*(u>0?p/u:0):0)+.25*Math.min(y/L*3.5+.6*D+1*q,1)),U=x/L,O=100*(.5*Math.min(Math.pow(U/4.5,.9),1)+.25*(A>0?Math.min(N/A,1):0)+.25*(I>0?Math.min(M/I,1):0)),B=100*(.4*Math.min(Math.pow(P/.22,.95),1)+.3*(_>0?Math.min(Math.pow(_/L/.45,.9),1):0)+.3*Math.min(Math.pow(T/L/.18,1.05),1));let V=.55*$+.2*H+.13*O+.12*B;if(n&&s&&n.effectiveEnemyElo){const e=n.avgADR||75,a=n.avgKD||1,r=i/Math.max(e,30)*.6+c/Math.max(a,.5)*.4,o=1-(s-n.effectiveEnemyElo)/2e3*.12,l=Math.max(.8,Math.min(1.2,o));V=V*Math.pow(r,.7)*l}return{performanceRating:Math.max(0,.95*V).toFixed(1),fraggingImpact:$.toFixed(1),entryClutch:H.toFixed(1),utilityUsage:O.toFixed(1),teamplay:B.toFixed(1)}}async function getFromCacheOrFetch(e,a,s=null){db||await initDB();const n=`${forecastCacheKeyPrefix}::${e}`;if(cacheMap.has(n)){const a=cacheMap.get(n);if(5===a.version){const s=a.data.rounds?.[0]?.teams?.every(e=>e.players.every(e=>void 0!==e.player_stats&&null!==e.elo));if(s)return a.lastUsed=Date.now(),await updateLastUsed(e,a.lastUsed),a.data;cacheMap.delete(n)}else cacheMap.delete(n)}try{const a=await getFromDB(e);if(5===a?.version){const s=a.data.rounds?.[0]?.teams?.every(e=>e.players.every(e=>void 0!==e.player_stats&&null!==e.elo));if(s)return a.lastUsed=Date.now(),cacheMap.set(n,a),await updateLastUsed(e,a.lastUsed),a.data}}catch(e){error("Error reading from IndexedDB:",e)}const r=await a(e);if(!r?.rounds?.[0])return null;let o=null;if(s)try{o=await s(e)}catch(e){}const l=new Map,i=[[],[]];o?.[0]?.teams&&o[0].teams.forEach((e,a)=>{e.players.forEach(e=>{l.set(e.playerId,e.elo),e.elo&&i[a].push(e.elo)})});const c=r.rounds[0],d=parseInt(c.round_stats.Rounds)||0,u={matchId:e,data:{rounds:[{teams:c.teams.map((e,a)=>{const s=e.players.map(e=>{const a=e.player_stats;return{adr:parseFloat(a.ADR)||0,kd:parseFloat(a["K/D Ratio"])||0}}),n=s.reduce((e,a)=>e+a.adr,0)/s.length,r=s.reduce((e,a)=>e+a.kd,0)/s.length,o=i[0===a?1:0];let l=null;if(o.length>=3){const e=[...o].sort((e,a)=>a-e).slice(0,3),a=e.reduce((e,a)=>e+a,0)/e.length,s=[...o].sort((e,a)=>e-a);l=.7*a+.3*s[Math.floor(s.length/2)]}return{teamIndex:a,avgADR:n,avgKD:r,effectiveEnemyElo:l,players:e.players}}).map(e=>{const a=e.players.map(a=>{const s=a.player_stats,n=l.get(a.player_id),r=e.effectiveEnemyElo?{avgADR:e.avgADR,avgKD:e.avgKD,effectiveEnemyElo:e.effectiveEnemyElo}:null,o=calculatePerformanceRating(s,d,n,r);return{player:a,playerElo:n,stats:s,rawRating:parseFloat(o.performanceRating)||0,fraggingImpact:o.fraggingImpact,entryClutch:o.entryClutch,utilityUsage:o.utilityUsage,teamplay:o.teamplay}}),s=a.reduce((e,a)=>e+a.rawRating,0);return{teamData:e,playersWithRawRatings:a,totalRawRating:s}}).map(({teamData:e,playersWithRawRatings:a,totalRawRating:s})=>({players:a.map(({player:e,playerElo:a,stats:n,rawRating:r,fraggingImpact:o,entryClutch:l,utilityUsage:i,teamplay:c})=>{const d=s>0?(r/s*100).toFixed(1):"0.0";return{nickname:e.nickname,player_id:e.player_id,elo:a??null,player_stats:{Kills:n.Kills||"0",Assists:n.Assists||"0",Deaths:n.Deaths||"0",ADR:(parseFloat(n.ADR)||0).toFixed(1),"K/D Ratio":(parseFloat(n["K/D Ratio"])||0).toFixed(2),"K/R Ratio":(parseFloat(n["K/R Ratio"])||0).toFixed(2),Headshots:n.Headshots||"0","Headshots %":(parseFloat(n["Headshots %"])||0).toFixed(0),MVPs:n.MVPs||"0",Rating:d,"Impact Score":o,"Entry/Clutch":l,Utility:i,Teamplay:c}}}),team_stats:{"Team Win":c.teams[e.teamIndex].team_stats["Team Win"]||"0","Final Score":c.teams[e.teamIndex].team_stats["Final Score"]||"0"}})),round_stats:{Rounds:c.round_stats.Rounds||"0",Score:c.round_stats.Score||"",Map:c.round_stats.Map||""}}]},cacheDate:Date.now(),lastUsed:Date.now(),version:5};return saveToDb(u).catch(e=>error("Error saving to IndexedDB:",e)),cacheMap.set(n,u),u.data}async function saveToDb(e){return new Promise((a,s)=>{const n=db.transaction("matches","readwrite").objectStore("matches").put(e);n.onsuccess=()=>a(),n.onerror=()=>s(n.error)})}async function getFromDB(e){return new Promise((a,s)=>{const n=db.transaction("matches","readonly").objectStore("matches").get(e);n.onsuccess=()=>a(n.result),n.onerror=()=>s(n.error)})}async function updateLastUsed(e,a){return new Promise((s,n)=>{const r=db.transaction("matches","readwrite").objectStore("matches"),o=r.get(e);o.onsuccess=()=>{const e=o.result;e&&(e.lastUsed=a,r.put(e),s())},o.onerror=()=>n(o.error)})}async function cleanCache(){db||await initDB();const e=db.transaction("matches","readwrite").objectStore("matches"),a=e.index("lastUsed");return new Promise((s,n)=>{const r=a.openCursor(),o=Date.now();let l=0;r.onsuccess=a=>{const n=a.target.result;if(n){const a=n.value;(o-a.lastUsed>1728e5||void 0===a.version||a.version<5)&&(e.delete(n.primaryKey),cacheMap.delete(`${forecastCacheKeyPrefix}::${a.matchId}`),l++),n.continue()}else{let e="";l>0&&(e+=`Deleted ${l} old or outdated entries from IndexedDB`),e&&println(e),s()}},r.onerror=()=>n(r.error)})}async function initializeMatchHistoryCache(){await initDB().then(()=>{tryCleanCache(),loadMatchHistoryCache()}).catch(error)}function formatDecimal(e){const a=parseFloat(e);return isNaN(a)?e:a.toFixed(1)}function filterUnmarkedNodes(e){return[...e].filter(e=>!e.parentNode.parentNode.parentNode.parentNode.parentNode.parentElement.hasAttribute("marked-as-bug"))}function shouldContinue(e,a,s,n){return 0!==e.length||(a<=10&&setTimeout(async()=>await n(s,a+1),100),!1)}function findPlayerInTeamsById(e,a){for(const s of e){const e=s.players.find(e=>e.player_id===a);if(e)return e}return null}function getLevelColor(e){return levelColors[e]||"#FFFFFF"}function getEloColor(e,a="cs2"){return getLevelColor(getLevel(e,a))}function insertAllLevelsToTable(e,a){levelIcons.forEach((s,n)=>{let r=s.cloneNode(!0);const o=e.querySelector(`[class*=level-node-${n}]`).getElementsByTagName("span")[0];o.removeAttribute("title");let l=r.getElementsByTagName("span")[0],i=l.getAttribute("title");if(l.removeAttribute("title"),l.setAttribute("styled-title",i),rankingModule.appendToAndHide(r.cloneNode(!0),o),n===a){l.style.width="36px",l.style.height="36px";let a=r.cloneNode(!0);rankingModule.appendToAndHide(a,e.querySelector("[class*=current-level]").getElementsByTagName("span")[0])}})}async function insertAllStatisticToNewTable(e){let a=extractGameType("cs2"),s=extractPlayerNick(),n=(await fetchPlayerStatsByNickName(s)).games[a],r=Number.parseInt(n.faceit_elo,10),o=getLevel(r,a),l=getBarProgress(r,a);insertAllLevelsToTable(e,o);let i=e.querySelector("[class*=current-elo]");i.innerText=`${r}`;let c=getLevelColor(o);i.style.setProperty("--glow-color",`${c}B3`);let d=gameLevelRanges[a];e.querySelector("[class*=elo-need-to-reach]").innerText=`${o===d.length?"":d[o].min-r}`,e.querySelector("[class*=elo-need-to-reach-text]").innerText=o===d.length?t("max_level_reached","You reached max level!"):`${t("points_needed","Points needed to reach level")} ${o+1}`;for(let a=1;a<=d.length;a++){const s=e.querySelector(`[class*=level-node-${a}]`),n=e.querySelector(`[class*=progress-bar-${a}]`);let i=getLevelIcon(a),c=levelIcons.get(a-1);c||(c=i);let u=levelIcons.get(a+1);u||(u=i);let p=getLevelColor(a-1)||getLevelColor(a),h=getLevelColor(a);n.style.setProperty("--gradient-start",p),n.style.setProperty("--gradient-end",h);let m=s.querySelector('[class~="level-value"]');const{min:y,max:f}=d[a-1];s.setAttribute("range",a===d.length?`${y}+`:`${y}-${f}`),m.innerText=y,o>a?(s.setAttribute("reached",""),n.style.width="100%"):o===d.length?(s.setAttribute("reached",""),n.style.width="100%",document.querySelector("[class*=progress-bar-20]").style.background="rgb(255, 85, 0)"):o===a&&r>=y&&r<=f?(s.setAttribute("reached",""),n.style.width=`${l}%`):n.style.width="0%"}}function getLevel(e,a){const s=gameLevelRanges[a];for(let a=0;a<s.length;a++)if(e>=s[a].min&&e<=s[a].max)return a+1;return-1}function getBarProgress(e,a){const s=gameLevelRanges[a],n=getLevel(e,a);if(-1===n)return 0;const r=s[n-1];return n<s.length&&s[n]?(e-r.min)/(r.max-r.min)*100:100}async function doAfterStatisticNodeAppear(e){await rankingModule.doAfterNodeAppear("[class*=styles__MainSection] > div > [class*=styles__Container]:has([class*=styles__SkillLevelsSection])",async a=>{if(a.parentElement?.parentElement?.parentElement?.matches&&!a.parentElement?.parentElement?.parentElement?.matches("[class*=SpotlightSearch__Content]")&&a.nodeType===Node.ELEMENT_NODE&&!a.querySelector(`[class~="forecast-statistic-table-${rankingModule.sessionId}"]`)){let s=document.createElement("div");appendToAndHide(s,a),await e(s)}})}async function handleSearchPlayerNode(e){await newLevelsModule.doAfterAsync(()=>isNodeReady(e),()=>processSearchPlayerNode(e))}function isNodeReady(e){const a=e?.firstChild?.firstChild;return!e||a&&a.childNodes?.length>2}async function processSearchPlayerNode(e){const a=e?.firstChild?.firstChild;if(!a)return;const s=extractPlayerNickFromNode(a),n=a.childNodes[2];await replacePlayerIcon(s,n)}function extractPlayerNickFromNode(e){let a=e.childNodes[1];for(let e=0;e<7&&(a=a.firstElementChild,"SPAN"!==a.tagName||0!==e);e++);return a?.innerText}async function replacePlayerIcon(e,a){await newLevelsModule.doAfterAsync(()=>findSvgIcon(a),a=>updatePlayerIcon(e,a))}function findSvgIcon(e){return Array.from(e?.firstElementChild?.childNodes||[]).find(e=>"svg"===e.tagName)}async function updatePlayerIcon(e,a){const s=await fetchPlayerStatsByNickName(e),{gameStats:n,gameType:r}=getStatistic(s);if(!n)return;const o=getLevelIcon(getLevel(Number.parseInt(n.faceit_elo,10),r)).firstChild;newLevelsModule.appendToAndHide(o,a),newLevelsModule.removalNode(o)}function getStatistic(e){let a="cs2",s=e.games[a];return s||(a="csgo",s=e.games[a]),{gameStats:s,gameType:a}}async function insertStatsToEloBar(e,a){let s="cs2",n=(await fetchPlayerStatsByNickName(e)).games[s];a.querySelector("a").setAttribute("href",`/${extractLanguage()}/players/${e}/stats/${s}`);let r=Number.parseInt(n.faceit_elo,10),o=getLevel(r,s),l=getBarProgress(r,s),i=a.querySelector("[class~=skill-current-level]");for(;i.firstChild;)i.firstChild.remove();const c=getLevelIcon(o);c.firstChild.style.width="38px",c.firstChild.style.height="38px",c&&i.appendChild(c);let d=gameLevelRanges[s],{min:u,max:p}=d[o-1],h=a.querySelector("a > div > div.details > div.flex-between > div.elo.progress-current-elo > div"),m=a.querySelector("a > div > div.details > div.flex-between > div.elo.progress-current-elo > svg");h.innerText=`${r}`,a.querySelector("[class~=min-elo-level]").innerText=`${u}`,a.querySelector("[class~=max-elo-level]").innerText=`${p===1/0?"":p}`;let y=o===d.length;a.querySelector("[class~=elo-to-de-or-up-grade]").innerText=`${u-r-1}/+${y?"\u221e":p-r+1}`;const f=a.querySelector("a > div > div.details > div:nth-child(2) > div.progress-container.elo-progress-bar-container > div");let g=getLevelColor(o+1)||getLevelColor(o),v=getLevelColor(o);h.style.setProperty("--glow-color",`${v}B3`),m.style.setProperty("--glow-color",`${v}B3`),f.style.setProperty("--glow-color",`${v}B3`),f.style.setProperty("--gradient-start",v),f.style.setProperty("--gradient-end",g),y?f.style.width="100%":(f.style.width=`${l}%`,f.style.backgroundSize="184px 100%",f.style.backgroundPosition="left center",f.style.backgroundRepeat="no-repeat")}function doAfterSearchPlayerNodeAppear(e){let a=extractLanguage();const s=new RegExp(`^/${a}/players/([a-zA-Z0-9-_]+)$`);newLevelsModule.doAfterNodeAppear(`[href*="/${a}/players/"]:not([${newLevelsModule.dataProcessedAttribute}])`,a=>{if(a.nodeType===Node.ELEMENT_NODE){let n=a?.parentElement;if(!n)return;if(!n.matches("[class*=styles__PlayersListContainer"))return;if(!n.parentElement)return;const r=a.getAttribute("href");r&&s.test(r)&&(newLevelsModule.processedNode(a),e(a))}})}function openExtensionPopup(){if(toggleExistingPopup())return;const e=createPopupStructure(getPopupURL());document.body.appendChild(e),setupFrameMessageHandler(e.querySelector("#forecast-popup-frame")),positionPopup(e),addPopupStyles(),setupOutsideClickHandler()}function toggleExistingPopup(){const e=document.getElementById("forecast-popup-container");return!!e&&(e.remove(),!0)}function getPopupURL(){return CLIENT_RUNTIME.getURL("src/visual/popup.html")}function createPopupStructure(e){const a=document.createElement("div");a.id="forecast-popup-container";const s=document.createElement("div");s.id="forecast-popup-content";const n=document.createElement("iframe");return n.src=e,n.id="forecast-popup-frame",n.setAttribute("allow","clipboard-write"),s.appendChild(n),a.appendChild(s),a}function setupFrameMessageHandler(e){e.onload=()=>{e.contentWindow.postMessage({action:"setBackgroundColor",color:"transparent"},"*")}}function positionPopup(e){const a=document.querySelector(".fc-logo-container");a&&applyPopupPosition(e,calculatePopupPosition(a.getBoundingClientRect(),detectLayoutType(a)))}function detectLayoutType(e){return e.closest("[class*=styles__RightSideContainer]")?"rightSidebar":e.closest("[class*=styles__TopContent]")?"topMenu":"default"}function calculatePopupPosition(e,a){const s=window.innerWidth,n=window.innerHeight;return{rightSidebar:()=>calculateRightSidebarPosition(e,480,400,s,n,10),topMenu:()=>calculateTopMenuPosition(e,480,400,s,n,10),default:()=>calculateDefaultPosition(e,480,s,10)}[a]()}function calculateRightSidebarPosition(e,a,s,n,r,o){let l=e.bottom+o,i=e.left;return l+s>r&&(l=Math.max(o,r-s-o)),i+a>n&&(i=Math.max(o,n-a-o)),{top:l,left:i,transformOrigin:"top left"}}function calculateTopMenuPosition(e,a,s,n,r,o){let l=e.top,i=e.left-a-o;return i<0&&(i=e.right+o,i+a>n&&(i=Math.max(o,e.left+e.width/2-a/2))),l+s>r&&(l=Math.max(o,r-s-o)),{top:l,left:i,transformOrigin:"top right"}}function calculateDefaultPosition(e,a,s,n){let r=e.right+n;return e.right+n+a>s&&(r=e.left-a-n),{top:e.top,left:r,transformOrigin:"top left"}}function applyPopupPosition(e,a){e.style.position="fixed",e.style.top=`${a.top}px`,e.style.left=`${a.left}px`;const s=e.querySelector("#forecast-popup-content");s&&a.transformOrigin&&(s.style.transformOrigin=a.transformOrigin)}function setupOutsideClickHandler(){document.addEventListener("click",handleOutsideClick)}function handleOutsideClick(e){const a=document.getElementById("forecast-popup-container"),s=document.querySelector(".fc-logo-container");a&&!a.contains(e.target)&&s&&!s.contains(e.target)&&(a.remove(),document.removeEventListener("click",handleOutsideClick))}function addPopupStyles(){if(document.getElementById("fc-popup-styles"))return;const e=document.createElement("style");e.id="fc-popup-styles",e.textContent="\n        #forecast-popup-container {\n            position: fixed;\n            z-index: 9999;\n            filter: drop-shadow(0 4px 20px rgba(0,0,0,0.25));\n        }\n        \n        #forecast-popup-content {\n            position: relative;\n            width: 480px;\n            height: 400px;\n            border-radius: 12px;\n            overflow: hidden;\n            background-color: transparent;\n            animation: fc-popup-appear 0.2s ease forwards;\n        }\n        \n        @keyframes fc-popup-appear {\n            from {\n                opacity: 0;\n                transform: scale(0.95);\n            }\n            to {\n                opacity: 1;\n                transform: scale(1);\n            }\n        }\n        \n        #forecast-popup-frame {\n            border: none;\n            width: 100%;\n            height: 100%;\n        }\n    ",document.head.appendChild(e)}function addLogoStyles(){if(document.getElementById("fc-logo-styles"))return;const e=document.createElement("style");e.id="fc-logo-styles",e.textContent="\n        @property --angle {\n            syntax: \"<angle>\";\n            initial-value: 0deg;\n            inherits: false;\n        }\n        \n        .fc-logo-container {\n            position: relative;\n            width: 44px;\n            height: 44px;\n        }\n        \n        .fc-logo-gradient {\n            position: relative;\n            width: 100%;\n            height: 100%;\n            border-radius: 8px;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        }\n        \n        .fc-logo-image {\n            width: 44px;\n            height: 44px;\n            border-radius: 8px;\n            position: relative;\n            z-index: 1;\n            transition: filter 0.2s ease;\n            image-rendering: -webkit-optimize-contrast;\n            image-rendering: crisp-edges;\n            -ms-interpolation-mode: bicubic;\n            filter: brightness(1) contrast(1.05);\n            box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        }\n        \n        .fc-logo-container:hover .fc-logo-image {\n            filter: brightness(var(--hover-brightness, 1.2)) contrast(1.05);\n        }\n        \n        .fc-logo-gradient::before,\n        .fc-logo-gradient::after {\n            content: '';\n            position: absolute;\n            height: 40px;\n            width: 40px;\n            border-radius: 8px;\n            z-index: 0;\n            background-image: conic-gradient(from var(--angle), #ff4500, #ff8c00, #ffcc00, #ff4500);\n            animation: var(--animation-speed, 4s) logo-spin linear infinite;\n        }\n        \n        .fc-logo-gradient::before {\n            filter: blur(var(--border-blur, 4px));\n            opacity: var(--border-opacity, 0.8);\n        }\n        \n        @keyframes logo-spin {\n            from { --angle: 0deg; }\n            to { --angle: 360deg; }\n        }\n        \n        #forecast-popup-container {\n            box-shadow: 0 4px 20px rgba(0,0,0,0.25);\n            border-radius: 8px;\n            overflow: hidden;\n        }\n    ",document.head.appendChild(e)}async function initExtension(){if(await isExtensionEnabled()){await initializeMatchHistoryCache(),await loadMatchHistoryCache(),await resourcesModule.produceOf("load"),await i18nModule.produceOf("load");for(let e of lobbyModules)e.isEnabled=await isSettingEnabled(e.module.id,e.isEnabledByDefault);setInterval(async function(){try{let e=window.location.href;if(e!==previousUrl){previousUrl=e;const a=defineLobby(e);await handleModules(a,previousLobby),previousLobby=a}}catch(e){error("Error in URL change handler:",e)}},50)}}function determineAction(e,a,s){const n=a&&(e.includes("*")||e.includes(a.pageType)),r=s&&(e.includes("*")||e.includes(s.pageType));return n&&r?"reload":n?"load":r?"unload":null}async function handleModules(e,a){for(let s of lobbyModules){if(!s.isEnabled)continue;const n=determineAction(s.pages,e,a);await s.module.produceOf(n)}}const FIREFOX="FIREFOX",CHROMIUM="CHROMIUM",BROWSER_TYPE="undefined"==typeof browser?CHROMIUM:FIREFOX,CLIENT_API=BROWSER_TYPE===FIREFOX?browser:chrome,CLIENT_RUNTIME=CLIENT_API.runtime,CLIENT_STORAGE=CLIENT_API.storage.sync,EXTENSION_VERSION=CLIENT_RUNTIME.getManifest().version,log_prefix="%c[%cFORE%cCAST%c]:";class PageType{constructor(e,a){this.name=e,this.pattern=a}test(e){return this.pattern.test(e)}extract(e){return e.match(this.pattern)}}class Lobby{constructor(e,a){this.pageType=e,this.gameType=null,this.lang=null,this.nickname=null,this._parse(e,a)}_parse(e,a){a&&(["stats","history","leagues","profile_game","tournaments"].includes(e)?(this.lang=a[1],this.nickname=a[2],this.gameType=a[3]):["friends","videos","inventory","clubs","profile","teams"].includes(e)?(this.lang=a[1],this.nickname=a[2],this.gameType="cs2"):["home","matchroom","matchmaking","parties"].includes(e)&&(this.lang=a[1]))}}const STATS=new PageType("stats",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/([^/]+)\/stats$/),HISTORY=new PageType("history",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/([^/]+)\/history$/),LEAGUES=new PageType("leagues",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/([^/]+)\/leagues$/),TOURNAMENTS=new PageType("tournaments",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/([^/]+)\/tournaments$/),FRIENDS=new PageType("friends",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/friends$/),VIDEOS=new PageType("videos",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/videos$/),INVENTORY=new PageType("inventory",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/inventory$/),CLUBS=new PageType("clubs",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/clubs$/),TEAMS=new PageType("teams",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/teams$/),PROFILE_GAME=new PageType("profile",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)\/([^/]+)$/),PROFILE=new PageType("profile",/^https:\/\/www\.faceit\.com\/([^/]+)\/players\/([^/]+)$/),MATCHROOM=new PageType("matchroom",/^https:\/\/www\.faceit\.com\/([^/]+)\/[\w-]+\/room\/([\w-]+)(\/.*)?$/),MATCHMAKING=new PageType("matchmaking",/^https:\/\/www\.faceit\.com\/([^/]+)\/matchmaking.*/),PARTIES=new PageType("parties",/^https:\/\/www\.faceit\.com\/([^/]+)\/(parties|club).*/),HOME=new PageType("home",/^https:\/\/www\.faceit\.com\/([^/]+)\/home.*/),pageTypes=[STATS,HISTORY,LEAGUES,TOURNAMENTS,FRIENDS,VIDEOS,INVENTORY,CLUBS,TEAMS,PROFILE_GAME,MATCHROOM,MATCHMAKING,PARTIES,PROFILE,HOME],baseUrlV1="https://www.faceit.com/api/stats/v1/stats/time/users",baseUrlV2="https://www.faceit.com/api/match/v2",baseUrlV3="https://www.faceit.com/api/stats/v3",baseUrlV4="https://open.faceit.com/data/v4",playerDataCache=new Map,playerGamesDataCache=new Map,matchDataCache=new Map,matchDataV1Cache=new Map,matchDataV2Cache=new Map,matchDataV3Cache=new Map,matchDataStatsCache=new Map,fetchV3=(e,a)=>fetchInternal(e,a,"application/json, text/plain, */*"),fetchV2=(e,a)=>fetchInternal(e,a,"application/json, text/plain, */*"),fetchV1=(e,a)=>fetchInternal(e,a,"application/json, text/plain, */*"),fetchV4Cached=(e,a,s)=>fetchCached(e,a,s,fetchV4),fetchV3Cached=(e,a,s)=>fetchCached(e,a,s,fetchV3),fetchV2Cached=(e,a,s)=>fetchCached(e,a,s,fetchV2),fetchV1Cached=(e,a,s)=>fetchCached(e,a,s,fetchV1),baseUrlFC="https://api.fforecast.net";let cachedDeviceId=null;class ObserveHandler{constructor(){this.observerAppearTasks=new Map,this.observerDisappearTasks=new Map,this.observer=null,this.isRegistered=!1}register(){this.isRegistered||(this.isRegistered=!0,this.observer=new MutationObserver(e=>{for(const a of e)if("childList"===a.type){for(const e of a.addedNodes)this.observerAppearTasks.forEach(async(a,s)=>{try{await a(e)}catch(e){error(e)}});for(const e of a.removedNodes)this.observerDisappearTasks.forEach(async(a,s)=>{try{await a(e)}catch(e){error(e)}})}}),this.observer.observe(document.body,{childList:!0,subtree:!0}))}observeAppear(e,a){this.observerAppearTasks.set(e,a)}observeDisappear(e,a){this.observerDisappearTasks.set(e,a)}releaseAppearTask(e){this.observerAppearTasks.delete(e)}releaseDisappearTask(e){this.observerDisappearTasks.delete(e)}async doAfterNodeDisappear(e,a,s){this.observeDisappear(s||e,async n=>{n.matches?.(e)&&(a(n),this.releaseAppearTask(s||e))})}async doAfterNodeAppear(e,a,s){this.observeAppear(s||e,async s=>{if(s.matches?.(e))await a(s);else if(1===s.nodeType){const n=s.querySelectorAll(e);for(const e of n)await a(e)}});let n=document.querySelector(e);n&&await a(n)}async doAfterNodeAppearWithCondition(e,a,s,n){this.observeAppear(n||e,async n=>{if(n.matches?.(e)&&a(n))await s(n);else if(1===n.nodeType){const r=n.querySelectorAll(e);for(const e of r)a(e)&&await s(e)}});let r=document.querySelector(e);r&&a(r)&&await s(r)}async doAfterAllNodeAppear(e,a,s){this.observeAppear(s||e,async s=>{if(s.matches?.(e)&&await a(s),1===s.nodeType)for(const n of s.querySelectorAll(e))await a(n)});let n=document.querySelectorAll(e);if(0!==n.length)for(const e of n)await a(e)}async doAfterAllNodeAppearPack(e,a,s){this.observeAppear(s||e,async()=>{let s=document.querySelectorAll(e);0!==s.length&&await a(s)});let n=document.querySelectorAll(e);0!==n.length&&await a(n)}release(){this.isRegistered&&(this.isRegistered=!1,this.observerAppearTasks.clear(),this.observerDisappearTasks.clear(),this.observer?.disconnect())}}class Module{constructor(e,a,s=()=>{}){this.id=e,this.loadAction=a,this.unloadAction=s,this.isLoaded=!1,this.processedNodes=[],this.nodesToRemove=[],this.hidedNodes=[],this.tasks=[],this.observeHandler=new ObserveHandler}async#e(){this.isLoaded||(println(`Module ${this.id} is loading`),this.#t(),this.observeHandler.register(),await Promise.resolve(this.loadAction()),this.isLoaded=!0,println(`Module ${this.id} is successfully loaded`))}async#a(){println(`Module ${this.id} is reloading`),await Promise.resolve(this.unloadAction()),this.#s(),this.isLoaded=!1,this.#t(),this.observeHandler.register(),await Promise.resolve(this.loadAction()),this.isLoaded=!0,println(`Module ${this.id} is successfully reloaded`)}async#n(){this.isLoaded&&(println(`Module ${this.id} is disabling`),await Promise.resolve(this.unloadAction()),this.#s(),this.isLoaded=!1,println(`Module ${this.id} is successfully disabled`))}#s(){this.observeHandler.release(),this.processedNodes.forEach(e=>{e?.removeAttribute(this.dataProcessedAttribute)}),this.processedNodes.length=0;for(let e of this.nodesToRemove)e?.remove();this.nodesToRemove.length=0,this.hidedNodes.forEach(e=>{e?.style?.removeProperty("display")}),this.hidedNodes.length=0,this.tasks.forEach(e=>{clearInterval(e)}),this.tasks.length=0}#t(){this.sessionId=Math.random().toString(36).substring(2,10),this.dataProcessedAttribute=`data-processed-${this.sessionId}`}processedNode(e){this.processedNodes.push(e),e.setAttribute(this.dataProcessedAttribute,"")}isProcessedNode(e){return e.hasAttribute(this.dataProcessedAttribute)}removalNode(e){this.nodesToRemove.push(e)}appendToAndHide(e,a){appendToAndHide(e,a),this.hidedNodes.push(a)}preppendToAndHide(e,a){preppendToAndHide(e,a),this.hidedNodes.push(a)}async doAfterNodeDisappear(e,a,s){return this.observeHandler.doAfterNodeDisappear(e,a,s)}async doAfterNodeAppear(e,a,s){return this.observeHandler.doAfterNodeAppear(e,a,s)}async doAfterNodeAppearWithCondition(e,a,s,n){return this.observeHandler.doAfterNodeAppearWithCondition(e,a,s,n)}async doAfterAllNodeAppear(e,a,s){return this.observeHandler.doAfterAllNodeAppear(e,a,s)}async doAfterAllNodeAppearPack(e,a,s){return this.observeHandler.doAfterAllNodeAppearPack(e,a,s)}async doAfterAsync(e,a,s=50){let n,r=!0;const checkCondition=async()=>{if(!r)return;const s=await e();s&&(r=!1,n&&n(),await a(s))};return await checkCondition(),n=this.every(s,checkCondition),()=>{r=!1,n&&n()}}doAfter(e,a,s=50){let n,r=!0;const checkCondition=()=>{if(!r)return;const s=e();s&&(r=!1,n&&n(),a(s))};return checkCondition(),n=this.every(s,checkCondition),()=>{r=!1,n&&n()}}every(e,a){const s=setInterval(a,e);return this.tasks.push(s),()=>clearInterval(s)}async produceOf(e){switch(e){case"load":await this.#e();break;case"reload":await this.#a();break;case"unload":await this.#n()}}temporaryFaceitBugFix(){let e=document.querySelector("[marked-as-bug]");e?document.querySelector('[role="dialog"][data-dialog-type="LEAF"]')?this.doAfterNodeDisappear('[role="dialog"][data-dialog-type="LEAF"]',a=>{e.removeAttribute("marked-as-bug")}):e.removeAttribute("marked-as-bug"):this.doAfterNodeAppear('[role="dialog"][data-dialog-type="LEAF"]',()=>{let e=document.getElementById("canvas-body");e.hasAttribute("marked-as-bug")||e.setAttribute("marked-as-bug","")})}}const parser=new DOMParser,levelIcons=new Map,htmls=new Map,svgDataURIs=new Map,logoSVGUrls=["src/visual/icons/logo.svg","src/visual/icons/rawlogo.svg"],htmlUrls=["src/visual/tables/forecaststyles.css","src/visual/tables/level-progress-table.html","src/visual/tables/team.html","src/visual/tables/player.html","src/visual/tables/match-counter-arrow.html","src/visual/tables/match-history-popup.html","src/visual/tables/elo-progress-bar.html","src/visual/tables/elo-progress-bar-master.html","src/visual/tables/skill-levels-info-table.html","src/visual/tables/levels/challenger.html",...logoSVGUrls,...Array.from({length:20},(e,a)=>`src/visual/tables/levels/level${a+1}.html`)];let isResourcesLoaded=!1;const resourcesModule=new Module("resources",async()=>{isResourcesLoaded||(await loadAllHTMLs(),await loadLevelIcons(),await loadSVGDataURIs(),setupStyles(),isResourcesLoaded=!0)}),I18N_SUPPORTED_LANGUAGES=["en","ru","de","fr","uk","pl"],I18N_DEFAULT_LANGUAGE="en",I18N_LANGUAGE_NAMES={en:"English",ru:"\u0420\u0443\u0441\u0441\u043a\u0438\u0439",de:"Deutsch",fr:"Fran\xe7ais",uk:"\u0423\u043a\u0440\u0430\u0457\u043d\u0441\u044c\u043a\u0430",pl:"Polski"};let i18nCurrentLanguage="en",i18nTranslations={},isI18nLoaded=!1;const i18nModule=new Module("i18n",async()=>{isI18nLoaded||(await initI18nLanguage(),await loadTranslations(i18nCurrentLanguage),isI18nLoaded=!0,println(`i18n loaded: language=${i18nCurrentLanguage}, translations loaded=${Object.keys(i18nTranslations).join(", ")}`))}),matchRoomModule=new Module("matchroom",async()=>{matchRoomModule.teamCache=new Map,matchRoomModule.temporaryFaceitBugFix();const e=extractMatchId();try{if(!e)return;await getMatchWinRates(e)}catch(e){error("Error when retrieving match statistics",e)}},async()=>{matchRoomModule.teamCache.clear()}),maps={Dust2:"de_dust2",Mirage:"de_mirage",Nuke:"de_nuke",Ancient:"de_ancient",Train:"de_train",Inferno:"de_inferno",Overpass:"de_overpass"},posCatcherModule=new Module("poscatcher",async()=>{const e=`${extractMatchId()}_poscatched`;getCookie(e)||posCatcherModule.doAfterNodeAppear("[name=info] > div[class*=Overview__Stack] > div[class*=Ready__Container]",()=>{posCatcherModule.doAfterNodeAppear("[name=info] > div[class*=Overview__Stack] > div > div > div > div:nth-child(4) > div > div[class*=middleSlot] > div > div > span > span",async a=>{if(getCookie(e))return;const s=a.innerText.trim();if(!s)return;const n=maps[s];if(!n)return;if(!await isSettingEnabled(`${n}Enabled`,!0))return;let r=await getSettingValue(`${n}Message`,"");"string"==typeof r&&""!==r.trim()&&posCatcherModule.doAfterAllNodeAppear("div[class*=styles__ChatSidebarContainer] > div > div:nth-child(2) > div[class*=ChatSection__ChatContainer] > div > div > div > div > div[class*=styles__MessageInputContainer] > div[class*=styles__InputWrapper] > div > div[class*=StyledTextArea__TextAreaWrapper] > textarea",a=>{getCookie(e)||(a.focus(),Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value").set.call(a,r),a.dispatchEvent(new Event("input",{bubbles:!0})),a.dispatchEvent(new Event("change",{bubbles:!0})),a.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0})),a.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",code:"Enter",keyCode:13,which:13,bubbles:!0})),setCookie(e,1,1440))})})})},async()=>{}),forecastCacheKeyPrefix="forecast-matchhistory",cookieCacheId="last-matchhistorycache-cleanup",cleanUpPeriod=864e5,maxUnusedHours=48,CACHE_VERSION=5,DB_NAME="faceit_matches",STORE_NAME="matches",DB_VERSION=1,cacheMap=new Map;let db=null;class MatchroomPopup{constructor(e,a){this.wrapper=e.querySelector("[class~=popup-wrapper]"),this.popup=this.wrapper.children[0],this.settings=a,this.popup.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation()})}attachToElement(e,a){const s=[this.popup.querySelector("#team-table-body-popup-1"),this.popup.querySelector("#team-table-body-popup-2")];if(s[0]?.children.length>0||s[1]?.children.length>0)return;const sortByADR=e=>e.sort((e,a)=>(parseFloat(a.player_stats.ADR)||0)-(parseFloat(e.player_stats.ADR)||0)),n=[sortByADR(e.rounds[0].teams[0].players),sortByADR(e.rounds[0].teams[1].players)],createRow=e=>{const s=document.createElement("tr");s.className="popup-table-row";const n=e.player_stats,r=n.Rating,o=e.elo,l=null!=r?"number"==typeof r?r.toFixed(1)+"%":r+"%":"-";return[e.nickname,n.Kills,n.Assists,n.Deaths,formatDecimal(n["K/R Ratio"]),formatDecimal(n["K/D Ratio"]),n.Headshots,formatDecimal(n.ADR),l,null!==o?o:"-"].forEach((n,r)=>{let o=document.createElement("td");o.className="popup-table-cell",0===r&&a===e.player_id&&(o.style.color="#FF5500",o.style.fontWeight="bold"),o.textContent=n,s.appendChild(o)}),s};for(let e=0;e<n.length;e++){const a=s[e],r=n[e].map(createRow);a.append(...r)}}}const MATCHES_PER_LOAD=30,green="rgb(61,255,108)",red="rgb(255, 0, 43)",white="rgb(255, 255, 255)";class MatchNodeChain{constructor(){this.nodes=new Map,this.head=null,this.tail=null}has(e){return this.nodes.has(e)}get(e){return this.nodes.get(e)}append(e){return this.nodes.has(e.matchId)?this.nodes.get(e.matchId):(this.nodes.set(e.matchId,e),this.head?(this.tail.next=e,this.tail=e):(this.head=e,this.tail=e),e)}}class MatchNodeByMatchStats{constructor(e,a,s,n,r){this.node=e,this.matchId=a,this.matchStats=null,this.rounds=0,this.index=s,this.nodeId=`extended-stats-node-${s}`,this.settings=n,this.tableHeader=r,this.next=null,this.elo=null,this.eloDiff=null,this.eloCalculated=!1,this.setupMatchCounterArrow()}isLast(){return!this.next}async calculateEloDiff(e){if(this.eloCalculated)return this.eloDiff;if(null===this.elo)return null;if(this.isLast()){if(this.cachedStats){const a=1e3*(await fetchMatchStats(this.matchId)).finished_at+1,s=(await fetchV1MatchRoundStats(e,extractGameType("cs2"),1,"5v5",a))[0].elo_delta;s&&(this.eloDiff=s,this.eloCalculated=!0)}}else{const e=this.next?.elo;null!=e&&(this.eloDiff=this.elo-e,this.eloCalculated=!0)}return this.eloDiff}setElo(e){this.elo=e}loadMatchStats(e,a){if(!a?.rounds?.[0])return void error(`No cached stats found for matchId: ${this.matchId}`);const s=findPlayerInTeamsById(a.rounds[0].teams,e);s?(this.cachedStats=a,this.matchStats=s.player_stats,this.rounds=Number.parseInt(a.rounds[0].round_stats.Rounds,10)||0,s.elo&&this.setElo(s.elo),this.setupStatsToNode(e,a)):error(`No stats found for playerId: ${e} in matchId: ${this.matchId}`)}setupStatsToNode(e,a){if(!this.matchStats)return;const s=this.node?.querySelector("div")?.lastChild,n=s?.children[1]?.lastChild;if(n){n.parentElement.parentElement.style.overflow="visible";let r=this.node.querySelector("[id*=extended-stats-node-]"),o=!r;o&&(r=getHtmlResource("src/visual/tables/match-history-popup.html").cloneNode(!0),r.id=this.nodeId),this.popup||(this.popup=new MatchroomPopup(r,this.settings),this.popup.attachToElement(a,e)),o&&(n.lastChild.style.justifyContent="center",n.appendChild(r),n.style.width="100px",s.children[0].lastChild.style.width="82px",matchHistoryModule.removalNode(r))}const r=s?.children[2]?.lastChild?.lastChild?.lastChild;let o=Number.parseInt(r?.innerText?.replace(/[\s,._]/g,"")??"0",10);if(!this.elo&&o&&this.setElo(o),this.eloNode=r,this.settings?.showFCR){if(s.querySelector('[class*="fcr-fc"]'))return;const e=this.matchStats.Rating,a=parseFloat(e);let n=null!==e?e+"%":"-",r=document.createElement("span");r.textContent=n,!1===this.settings?.coloredStatsFCR||isNaN(a)?r.style.color=white:r.style.color=a>=20?green:a>=15?"rgb(255, 200, 0)":red;let o=s?.children[6];o&&(r.className=o.className,r.classList.add("fcr-fc"),o.after(r))}this.setupStats(s)}fixHeaderMax(e){if(!this.tableHeader||!e)return;const a=this.tableHeader.lastElementChild.lastElementChild.lastElementChild;if(!a)return;const s=Array.from(a.children),n=Array.from(e.children),r=["82px","100px","100px","84.5px","84.5px","84.5px","84.5px"];this.settings?.showFCR&&r.push("84.5px");for(let e=0;e<r.length;e++){const a=r[e],o=s[e],l=n[e];o&&(o.style.width=a,o.style.minWidth=a),l&&(l.style.width=a,l.style.minWidth=a)}}setupStats(e){const a=e?.children[3],s=e?.children[4],n=e?.children[5],r=e?.children[6];if(!a)return;const o=a.innerText?.split("/").map(e=>parseNumber(e))||[],[l,i,c]=o,d=i?l/i:0;if(!1!==this.settings?.coloredStatsKDA){const e=createCompositeCell([{text:l,condition:d>=1},{text:"/",condition:null,isSlash:!0},{text:i,condition:d>=1},{text:"/",condition:null,isSlash:!0},{text:c,condition:null}]);e.className=a.className,a.replaceWith(e)}if(!1!==this.settings?.coloredStatsADR){const e=parseNumber(s?.innerText,!0);replaceNodeWithColored(s,e.toFixed(1),e>=75)}if(!1!==this.settings?.coloredStatsKD&&replaceNodeWithColored(n,d.toFixed(1),d>=1),!1!==this.settings?.coloredStatsKR){const e=parseNumber(r?.innerText,!0);replaceNodeWithColored(r,e.toFixed(1),e>=.7)}this.fixHeaderMax(e)}async applyEloDiff(e){if(!1===this.settings?.eloHistoryCalculation)return;const a=await this.calculateEloDiff(e);if(null!==a&&this.eloNode){let e=this.eloNode.parentElement,s="elodif";if(e.querySelector(`[class=${s}]`))return;let n=document.createElement("span");n.classList.add(s),n.innerText=`${a>0?"+":""}${a}`,e.style.flexDirection="row",e.style.alignItems="baseline",e.style.gap="3px",e.style.width="60px",n.style.color=`${a>0?green:a<0?red:white}`,n.style.fontSize="smaller",e.appendChild(n)}}setupMatchCounterArrow(){if(!1===this.settings?.matchCounter)return;let e=this.index+1;if(e%30!=0)return;let a="arrow-"+e/30;if(!document.getElementById(a)){const s=getHtmlResource("src/visual/tables/match-counter-arrow.html").cloneNode(!0);s.id=a,s.style.position="relative",s.style.zIndex="2",s.style.bottom="0px",s.style.left="4px",s.style.position="absolute",this.node.querySelector("div").prepend(s),s.querySelectorAll("*").forEach(e=>{e.style.position="relative",e.style.zIndex="2"}),s.querySelector("[class~=match-counter-arrow-square]").innerText=e}}}const matchHistoryModule=new Module("matchhistory",async()=>{async function settings(){return r||(r=await getSettings({eloHistoryCalculation:!0,matchCounter:!0,coloredStatsKDA:!0,coloredStatsADR:!0,coloredStatsKD:!0,coloredStatsKR:!0,showFCR:!0,coloredStatsFCR:!0}),r)}async function createBatchFromNodes(e,s){const n=[];let r=await settings();for(let l of e){const e=s.indexOf(l);if(-1===e)continue;const i=extractMatchId(l),c=new MatchNodeByMatchStats(l.children[0],i,e,r,a);o.append(c),n.push(c)}return n}function extractMatchId(e){return e.href.match(c)[1]}async function loadMatchStatsForBatch(e){let a=await async function playerId(){return n||(n=(await fetchPlayerStatsByNickName(s)).player_id,n)}();await Promise.all(e.map(async e=>{const s=await getFromCacheOrFetch(e.matchId,fetchMatchStatsDetailed,fetchV3MatchStats);s&&e.loadMatchStats(a,s)}));for(const s of e)await s.applyEloDiff(a)}matchHistoryModule.temporaryFaceitBugFix();let e,a,s=extractPlayerNick(),n=null,r=null;const o=new MatchNodeChain;let l=`forecast-matchhistory-row-${matchHistoryModule.sessionId}`,i=`a[href^="/${extractLanguage()}/${extractGameType("cs2")}/room/"][href$="/scoreboard"]:not([${l}]):not(:has([id*=extended-stats-node]))`;const c=/\/room\/([^/]+)\/scoreboard/;await matchHistoryModule.doAfterAllNodeAppearPack(i,async function callback(s,n){a&&!a.isConnected&&(a=null,e=null);const r=filterUnmarkedNodes(s);if(!shouldContinue(r,n||0,s,callback))return;await async function initializeTableElements(s){if(e||(e=s[0].parentNode.children),!a&&(a=e[0],(await settings()).showFCR)){if(a.querySelector('[class*="fcr-fc-header"]'))return;let e=a.querySelector("div > div > div:nth-child(7)");if(e){let a=document.createElement("div");a.className=e.className,a.classList.add("fcr-fc-header"),a.appendChild(document.createTextNode("FCR")),e.after(a)}}}(r);const o=function prepareNodeArrays(e){return chunkArray(e.filter(e=>function filterAndMarkNode(e){const s=a!==e&&!e.hasAttribute(l);return s&&e.setAttribute(l,""),s}(e)),30)}(r);0!==o.length&&await async function processNodeBatches(a){const s=Array.from(e).filter(e=>"A"===e.tagName);for(const e of a){const a=await createBatchFromNodes(e,s);await loadMatchStatsForBatch(a)}}(o)})},async()=>{}),gameLevelRanges={cs2:[{min:100,max:500},{min:501,max:750},{min:751,max:900},{min:901,max:1050},{min:1051,max:1200},{min:1201,max:1350},{min:1351,max:1530},{min:1531,max:1750},{min:1751,max:2e3},{min:2001,max:2250},{min:2251,max:2500},{min:2501,max:2750},{min:2751,max:3e3},{min:3001,max:3250},{min:3251,max:3500},{min:3501,max:3750},{min:3751,max:4e3},{min:4001,max:4250},{min:4251,max:4500},{min:4501,max:1/0}],csgo:[{min:100,max:800},{min:801,max:950},{min:951,max:1100},{min:1101,max:1250},{min:1251,max:1400},{min:1401,max:1550},{min:1551,max:1700},{min:1701,max:1850},{min:1851,max:2e3},{min:2001,max:2250},{min:2251,max:2500},{min:2501,max:2750},{min:2751,max:3e3},{min:3001,max:3250},{min:3251,max:3500},{min:3501,max:3750},{min:3751,max:4e3},{min:4001,max:4250},{min:4251,max:4500},{min:4501,max:1/0}]},levelColors={1:"#EEE",2:"#1CE400",3:"#1CE400",4:"#FFC800",5:"#FFC800",6:"#FFC800",7:"#FFC800",8:"#FF6309",9:"#FF6309",10:"#FE1F00",11:"#FE0123",12:"#FD0346",13:"#FE0379",14:"#FF019B",15:"#CC29C8",16:"#4693EC",17:"#1FB2F7",18:"#00CBFF",19:"#4CDBFF",20:"#FFFFFF"},rankingModule=new Module("eloranking",async()=>{rankingModule.temporaryFaceitBugFix(),doAfterStatisticNodeAppear(async e=>{e.parentElement.querySelector("[class*=forecast-statistic-table]")?.remove();let a=getHtmlResource("src/visual/tables/level-progress-table.html").cloneNode(!0);localizeHtmlResource(a),appendTo(a,e),e.remove(),a.classList.add(`forecast-statistic-table-${rankingModule.sessionId}`),setupBrandIcon(a,32,32),await insertAllStatisticToNewTable(a)})});let partySlots=new Map;class PartySlot{nick=null;constructor(e,a){this.slotNode=e,this.newIcon=null,this.isEmpty=!0,this.isShort=null,this.id=a}isShortStyle(){let e=this.slotNode?.firstElementChild?.querySelector("[class*='ButtonBase__Wrapper']")?.querySelector("[class*='PlayerCardListItem__Row-']");return!!e}getNickNode(e){let a;return a=e?this.slotNode?.firstElementChild?.querySelector("[class*=Nickname__Name]"):this.slotNode?.firstElementChild?.querySelector("[role=button]")?.children[1]?.children[0],a?.innerText&&(this.isEmpty=!1),a}getLevelNode(e){let a;return a=e?this.slotNode?.firstElementChild?.querySelector("[class*=SkillIcon__StyledSvg]"):this.slotNode?.firstElementChild?.querySelector("[role=button]")?.children[2],a}isNeedRemove(){let e=this.isShortStyle();null===this.isShort&&(this.isShort=e);let a=!1;this.isShort!==e&&(a=!0,this.isShort=e);let s=this.getNickNode(e);return s?.isConnected&&!a}removeOldIcon(){let e=this.getLevelNode(this.isShort);if(!e)return;let a=e.querySelector("[class*=SkillIcon__StyledSvg]");a&&"none"!==a.style.display&&(a.style.display="none")}async updateIcon(){const e=this.getNickNode(this.isShort)?.innerText;if(!e)return;if(e===this.nick&&this.newIcon)return;const a=await this.getIconData(e);a&&(this.replaceIcon(a),this.nick=e)}async getIconData(e){const a=this.getLevelNode(this.isShort);if(!a)return null;const s=await this.getElo(e,a);if(!s)return null;const n=this.getOldIcon(a);if(!n)return null;const r=getLevel(s,"cs2");return{levelNode:a,oldIcon:n,newIcon:this.createNewIcon(r)}}async getElo(e,a){return this.isShort?await this.getEloFromStats(e):this.getEloFromNode(a)}async getEloFromStats(e){const a=await fetchPlayerStatsByNickName(e),{gameStats:s}=getStatistic(a);return s?Number.parseInt(s.faceit_elo,10):null}getEloFromNode(e){const a=e.querySelector("[class*=styles__EloText]");if(!a)return null;const s=a.innerText;return s?Number.parseInt(s.replace(/[\s,._]/g,""),10):null}getOldIcon(e){return this.isShort?e:e.querySelector("[class*=SkillIcon__StyledSvg]")}createNewIcon(e){const a=getLevelIcon(e).firstChild;return a.classList.add(`party-slot-icon-${this.id}`),a}replaceIcon({levelNode:e,oldIcon:a,newIcon:s}){this.removeExistingIcon(),e.querySelector(`[class~=party-slot-icon-${this.id}]`)||(newLevelsModule.appendToAndHide(s,a),newLevelsModule.removalNode(s),this.newIcon=s)}removeExistingIcon(){this.newIcon&&(this.newIcon.remove(),this.newIcon=null,this.isEmpty=!0)}}const newLevelsModule=new Module("eloranking",async()=>{newLevelsModule.temporaryFaceitBugFix(),hideWithCSS("[class*=SkillIcon__StyledSvg]:not([origin-levels]):not([origin-levels] *)");const e=document.createElement("style");e.textContent="span[id*=lvlicon]:has(+ [class*=SkillIcon__StyledSvg]) {margin-inline-end: 0 !important;}",document.head.appendChild(e),await newLevelsModule.doAfterNodeAppear("div[class*=Content__StyledContentElement][data-dialog-type=TRAY]:not([marked-as-bug])",async e=>{let uniqueCheck=()=>e?.parentElement?.querySelector("[id*=statistic-progress-bar]");uniqueCheck()||await newLevelsModule.doAfterAsync(()=>e.querySelector("[class*=styles__HeadingWrapper]"),async e=>{if(uniqueCheck())return;let a=e.innerText,s=e.parentElement.parentElement.querySelector("[class*=styles__BottomAreaWrapper]"),n=getHtmlResource("src/visual/tables/elo-progress-bar.html").cloneNode(!0);setupBrandIcon(n,24,24),n.id="statistic-progress-bar",await insertStatsToEloBar(a,n),preppendTo(n,s,"progress-bar"),newLevelsModule.removalNode(n)})});let a=defineLobby(window.location.href),s=newLevelsModule.sessionId,n=`session-${s}-new-elo-level-icon`,r=`session-${s}-lvlicon`,o=`session-${s}-level-info-table-container`,l=`session-${s}-matchmaking-holder`,i=`session-${s}-collection-level-icon`;if("matchroom"===a.pageType){let c,d=extractGameType("cs2"),u=extractMatchId(),p="[class*=Subtitle__Holder]",h='[role="dialog"] > div[class*=styles__ScrollableContainer] > div[class*=SkillLevel__StatsContainer] > div > span',m="div[class*=Scoreboard__Main] > div > div[class*=styles__Flex] > div[class*=styles__MvpWrapper] > div > div[class*=styles__MvpCardHolder] > div > div[class*=Tag__Container] > span",y="#tooltip-portal > div > div > div > div:nth-child(3)",f="div[class*=Scoreboard__Main] > div > div[class*=styles__Section] > div[class*=styles__ScrollWrapper] > table > tbody > tr > td:nth-child(2) > div > div",g="div[class*=Scoreboard__Main] > div > div[class*=styles__ScrollWrapper] > table > tbody > tr > td:nth-child(2) > div > div",preppendIconOnEloNodeFound=async e=>{let a=e.innerText.replace(/[\s,._]/g,"");if(!isNumber(a))return;let s=e.parentElement;if(s.parentElement.querySelector(`[id*=${r}]`))return;let n=getLevel(Number.parseInt(a,10),d),o=getLevelIcon(n).firstChild;o.id=`${r}${n}`,preppendTo(o,s),newLevelsModule.removalNode(o)};await newLevelsModule.doAfterAllNodeAppear(y,async e=>{c||(c=await fetchMatchStats(u));let avgLevelHandler=a=>{let s=getLevelIcon(getLevel(c.teams[`faction${a}`].stats.rating,d)).firstChild;e.querySelector(`div:nth-child(${a})`)?.appendChild(s)};avgLevelHandler(1),avgLevelHandler(2)}),await newLevelsModule.doAfterAllNodeAppear(g,preppendIconOnEloNodeFound),await newLevelsModule.doAfterAllNodeAppear(f,preppendIconOnEloNodeFound),await newLevelsModule.doAfterAllNodeAppear(m,preppendIconOnEloNodeFound),await newLevelsModule.doAfterAllNodeAppear(h,preppendIconOnEloNodeFound),await newLevelsModule.doAfterAllNodeAppear(p,async e=>{if(!isNumber(e.innerText))return;let a=e.parentElement.parentElement;if(a.parentElement.querySelector(`[id*=${r}]`))return;let s=getLevel(Number.parseInt(e.innerText,10),d),n=getLevelIcon(s).firstChild;n.id=`${r}${s}`,appendTo(n,a),newLevelsModule.removalNode(n)})}else if("profile"===a.pageType){let v="[class*=styles__MainSection] > [class*=styles__EloAndLeagueContainer] > div > [class*=styles__Flex] > div > div > span[class*=Text]";await newLevelsModule.doAfterNodeAppear(v,async e=>{const s=getNthParent(e,2);let n="main-profile-icon";const updateIcon=r=>{if(r?.some(e=>[...e.addedNodes,...e.removedNodes].some(e=>1===e.nodeType&&e.classList.contains(n))))return;s.querySelector(`[class*='${n}']`)?.remove();let o=s.querySelector("[class*=BadgeHolder__Holder]"),l=getLevel(Number.parseInt(e.textContent.replace(/[\s,._]/g,""),10),a.gameType),i=getLevelIcon(l);const c=getLevelColor(l);let d=i.firstChild;d.style.width="64px",d.style.height="64px";let u=s.parentElement.parentElement;if(u.classList.add("profile-level-container"),u.style.setProperty("--glow-color",c),u.style.setProperty("--glow-color-1",`${c}2E`),u.style.setProperty("--glow-color-2",`${c}14`),u.style.setProperty("--glow-color-3",`${c}00`),u.style.setProperty("--glow-color-4",`${c}0B`),u.style.setProperty("--glow-color-5",`${c}05`),u.style.setProperty("--glow-color-6",`${c}00`),e.style.whiteSpace="nowrap",o){let e=document.createElement("div"),a=o.parentElement;e.appendChild(i),e.classList.add(n),d.style.width="52px",d.style.height="52px",o.style.scale="0.7",a.prepend(e),newLevelsModule.removalNode(e)}else i.classList.add(n),s.prepend(i),newLevelsModule.removalNode(i)};updateIcon(),new MutationObserver(updateIcon).observe(s,{childList:!0,characterData:!0,subtree:!0})});let w="[class*=styles__MainSection] > div:nth-child(3) > [class*=styles__Col] > a > div > div > div > div:nth-child(3) > div > div:nth-child(2) > span";await newLevelsModule.doAfterAllNodeAppear(w,async e=>{let s=e.parentElement.parentElement,r=getLevelIcon(getLevel(Number.parseInt(e.textContent.replace(/[\s,._]/g,""),10),a.gameType));r.classList.add(n),s.querySelector(`[class*='${n}'`)||s.prepend(r)});let b="[class*=styles__MainSection] > [class*=styles__Flex] > [class*=styles__Container] > div > [class*=styles__RightPanel] > [class*=styles__RightPanelFooter] > [class*=styles__Col]";await newLevelsModule.doAfterAllNodeAppear(b,async e=>{let a=e.querySelector("[unique]");a?.remove();let s=getNthParent(e,4),n=s.parentElement;if(Array.from(n.children)[2]!==s)return;let r=extractPlayerNick(),o=await fetchPlayerStatsByNickName(r),{gameStats:l,gameType:i}=getStatistic(o);if(!l)return;let c=getLevelIcon(getLevel(Number.parseInt(l.faceit_elo,10),i));c.setAttribute("unique",""),c.style.scale="1.25",e.appendChild(c)});let S="[class*=styles__TickIconWrapper]";await newLevelsModule.doAfterAllNodeAppear(S,e=>{if(e.querySelector("[unique]"))return;let a=getNthParent(e,13),s=a.parentElement;if(Array.from(s.children)[2]!==a)return;let n=e.innerText,r=getLevelIcon(getLevel(Number.parseInt(n.replace(/[\s,._]/g,""),10),extractGameType("cs2")));r.setAttribute("unique",""),r.firstChild.style.width="24px",r.firstChild.style.height="24px",e.querySelector("span[class*=styles__SkillIconWrapper]")?.remove(),e.prepend(r)})}else if("stats"===a.pageType){let E="[class*=styles__MainSection] > [class*=styles__Flex] > [class*=styles__Container] > div > div > [class*=styles__RightPanel] > [class*=styles__RightPanelFooter] > [class*=styles__Flex] > [class*=styles__Flex] > span";await newLevelsModule.doAfterAllNodeAppear(E,async e=>{if(e.parentElement.querySelector("[unique]"))return;let a=getNthParent(e,2),s=a.parentElement,n=getNthParent(a,4),r=n.parentElement;if(Array.from(r.children)[2]!==n)return;let o=Array.from(s.children);if(o[0]!==a&&o[2]!==a)return;const updateIcon=()=>{let a=e.innerText,s=getLevelIcon(getLevel(Number.parseInt(a.replace(/[\s,._]/g,""),10),extractGameType("cs2")));s.setAttribute("unique",""),s.firstChild.style.width="24px",s.firstChild.style.height="24px";const n=e.parentElement.querySelector("[unique]");n&&n.remove(),e.parentElement.prepend(s)};updateIcon(),new MutationObserver(updateIcon).observe(e,{childList:!0,characterData:!0,subtree:!0})});let C="[class*=styles__TickIconWrapper]";await newLevelsModule.doAfterAllNodeAppear(C,e=>{if(e.querySelector("[unique]"))return;let a=getNthParent(e,13),s=a.parentElement;if(Array.from(s.children)[2]!==a)return;let n=e.innerText,r=getLevelIcon(getLevel(Number.parseInt(n.replace(/[\s,._]/g,""),10),extractGameType("cs2")));r.setAttribute("unique",""),r.firstChild.style.width="24px",r.firstChild.style.height="24px",e.querySelector("span[class*=styles__SkillIconWrapper]")?.remove(),e.prepend(r)})}else if("history"===a.pageType){let x="[class*=styles__MainSection] > [class*=styles__Flex] > a > div > div > div > div:nth-child(3) > div > div > span[class*=Text]";await newLevelsModule.doAfterAllNodeAppear(x,e=>{let s=e.parentElement.parentElement,r=getLevelIcon(getLevel(Number.parseInt(e.textContent.replace(/[\s,._]/g,""),10),a.gameType));r.classList.add(n),s.querySelector("[class*='-new-elo-level-icon']")?.remove(),s.prepend(r)})}else if("matchmaking"===a.pageType){let A="[class*=Matchmaking__PlayHolder]",N="main[class*=Layout__Container] > div[class*=Header__Container] > div:nth-child(2) > div > div > div:nth-child(1) > button > div > div:nth-child(1)",I="main[class*=Layout__Container] > div[class*=Header__Container] > div:nth-child(2) > div > div > div:nth-child(1) > div > div:nth-child(2) > div:nth-child(1) > div[class*=LevelWidget__IconWrapper]";function isMatchmakingHolder(e){return e.id===l}async function processPartySlot(e,a){a.removeOldIcon(),function shouldRemoveSlot(e){return!e.isNeedRemove()&&!e.isEmpty}(a)?function removePartySlot(e,a){partySlots.delete(e),a.slotNode.classList.remove(e),a.newIcon&&a.newIcon.remove()}(e,a):await a.updateIcon()}await newLevelsModule.doAfterNodeAppear(N,e=>{if(e.querySelector("[class*=elowidgeticon]"))return;let a=e.parentElement.querySelector("div:nth-child(2) > div:nth-child(2) > h5").innerText,s=getLevel(Number.parseInt(a.replace(/[\s,._]/g,""),10),"cs2"),n=e.parentElement.querySelector("div:nth-child(2) > div:nth-child(1) > span"),r=n.innerText,o=r.match(/.+ (\d+)/)[1];n.innerText=r.replace(o,s);let l=getLevelIcon(s),i=l.querySelector('path[fill="#111111"]');i&&i.setAttribute("fill","#1F1F22"),l.classList.add("elowidgeticon");let c=l.firstChild;c.style.width="58px",c.style.height="58px",c.style.margin="2px 0px",e.appendChild(l)}),await newLevelsModule.doAfterNodeAppear(I,e=>{if(e.querySelector("[class*=elowidgeticon]"))return;let a=e.parentElement.querySelector("h1").innerText,s=getLevelIcon(getLevel(Number.parseInt(a.replace(/[\s,._]/g,""),10),"cs2"));s.classList.add("elowidgeticon"),e.appendChild(s)}),await newLevelsModule.doAfterNodeAppear(A,async function handleNodeAppear(e){isMatchmakingHolder(e)||(await async function waitForTableStructure(e){await newLevelsModule.doAfterAsync(()=>function checkTableStructure(e){const a=e.firstElementChild;if(!a)return!1;const s=2===a.children?.length,n=5===a.children?.[1]?.children?.length;return s&&n}(e),()=>{})}(e),isMatchmakingHolder(e)||(function startPartySlotUpdater(e){let a=!1;newLevelsModule.every(100,async()=>{if(!a){a=!0;try{!function initializePartySlots(e){partySlots.size>=5||Array.from(e.children).forEach((e,a)=>{const s=`party-slot-${a}`;e.classList.contains(s)||(e.classList.add(s),partySlots.set(s,new PartySlot(e,a)))})}(e),await async function updateAllPartySlots(){for(let e=0;e<partySlots.size;e++){const a=`party-slot-${e}`,s=partySlots.get(a);await processPartySlot(a,s)}}()}finally{a=!1}}})}(function getPartyTable(e){return Array.from(e.firstElementChild.children)[1]}(e)),function markAsMatchmakingHolder(e){e.id=l}(e)))})}else if("home"===a.pageType){let M="#canvas-body > [class*=home__Container] > div > [class*=style__SocialGameFeed] > div > [class*=styles__PlayBlock] > [class*=styles__GameSelectorWrapper] > [class*=EloWidget__Wrapper] > [class*=styles__Flex] > h5";await newLevelsModule.doAfterNodeAppear(M,async e=>{let a=e.textContent,s=getLevelIcon(getLevel(Number.parseInt(a.replace(/[\s,._]/g,""),10),"cs2")).firstChild;s.style.width="24px",s.style.height="24px",e.parentElement.prepend(s)})}if("profile"===a.pageType||"stats"===a.pageType||"parties"===a.pageType){let _="[class*=styles__EloText]";await newLevelsModule.doAfterNodeAppear(_,async e=>{let uniqueCheck=()=>e.matches(`[class*=${i}]`);if(uniqueCheck())return;let a=e.innerText,s=Number.parseInt(a.replace(/[\s,._]/g,""),10);await newLevelsModule.doAfterAsync(()=>e.parentElement.querySelector("svg"),a=>{if(uniqueCheck())return;let n=getLevelIcon(getLevel(s,"cs2")).firstElementChild;newLevelsModule.appendToAndHide(n,a),newLevelsModule.removalNode(n),e.classList.add(i)})}),"parties"===a.pageType&&["[class*=styles__RequirementsHolder]","[class*=styles__BadgesHolder]"].forEach(e=>{newLevelsModule.doAfterNodeAppear(e,e=>{e.hasAttribute("origin-levels")||e.setAttribute("origin-levels","")})})}await newLevelsModule.doAfterNodeAppear("body > div.FuseModalPortal > div > div > div[class*=SkillLevelsInfo__ModalContent]",e=>{if(!e?.parentElement?.querySelector("[id*=level-info-table-container]")){e.parentElement.style.width="560px";let a=getHtmlResource("src/visual/tables/skill-levels-info-table.html").cloneNode(!0);localizeHtmlResource(a),a.id=o;let s=a.querySelector("[class*=challengerinfos-icon]"),n=getHtmlResource("src/visual/tables/levels/challenger.html").cloneNode(!0).firstChild;n.style.scale="1.3",s.appendChild(n);let r=gameLevelRanges.cs2;for(let e=1;e<=r.length;e++){let s=a.querySelector(`[class="levelinfos-item lvl-${e}"]`),n=s.querySelector("[class=levelinfos-icon]"),o=getLevelIcon(e).firstChild;o.style.scale="1.15";const{min:l,max:i}=r[e-1];s.querySelector("[class='levelinfos-name']").innerText=`${t("level","Level")} ${e}`,s.querySelector("[class=levelinfos-range]").innerText=20===e?`(${l}+)`:`(${l} - ${i})`,n.appendChild(o)}newLevelsModule.appendToAndHide(a,e),newLevelsModule.removalNode(a)}}),doAfterSearchPlayerNodeAppear(handleSearchPlayerNode)},()=>{partySlots.forEach((e,a)=>{e.slotNode.classList.remove(a)}),partySlots.clear()}),logoSidebarModule=new Module("logoSidebar",async()=>{const e={borderWidth:"2px",borderBlur:"4px",borderOpacity:"0.8",animationSpeed:"4s",brightness:"1.2"},createLogoContainer=(a=!1)=>{const s=document.createElement("div");s.id="fc-logo-button",s.className="fc-logo-container",s.style.cursor="pointer",s.title="FORECAST",a&&(s.style.margin="0px 10px 10px 10px");const n=document.createElement("div");n.className="fc-logo-gradient",Object.entries(e).forEach(([e,a])=>{const s=`--${e.replace(/([A-Z])/g,"-$1").toLowerCase()}`;n.style.setProperty(s,a)});const r=document.createElement("img");return r.src=getSVGDataURI("src/visual/icons/rawlogo.svg"),r.alt="Forecast Logo",r.className="fc-logo-image",r.style.background="#1c1c1c",r.style.border="1px solid rgb(255 106 0 / 42%)",n.appendChild(r),s.appendChild(n),s.addEventListener("click",openExtensionPopup),s};await logoSidebarModule.doAfterNodeAppear("[class*=styles__TopContent]",e=>{if(document.getElementById("fc-logo-button"))return;const a=createLogoContainer(!0);e.appendChild(a),addLogoStyles()}),await logoSidebarModule.doAfterNodeAppear("[class*=styles__RightSideContainer]",e=>{if(document.getElementById("fc-logo-button"))return;const a=createLogoContainer();e.prepend(a),addLogoStyles()})},async()=>{}),serviceModule=new Module("service",async()=>{await fetchPing(),serviceModule.every(12e4,async()=>{await fetchPing()})},async()=>{}),integrationsModule=new Module("integrations",async()=>{let e,a=defineLobby(window.location.href)?.pageType;if("stats"!==a&&"matchroom"!==a)return;try{const s=extractLanguage();e=await fetchBannerData(s,a)}catch(e){error(e)}if(!e)return;const s=sanitizeHtml(e.html),createBanner=()=>{let a=document.createElement("div");return a.innerHTML=s,a&&e.targetUrl&&(a.style.cursor="pointer",a.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),isValidUrl(e.targetUrl)&&window.open(e.targetUrl,"_blank","noopener,noreferrer")})),a.classList.add("forecast-banner"),a};"stats"===a?await integrationsModule.doAfterNodeAppear("[class*=forecast-statistic-table]",async e=>{let a=e.querySelector("[class*=level-progress-container]");if(a){const e=createBanner();let s=a.querySelector("[class*='forecast-banner']");s&&s.remove(),appendTo(e,a)}}):"matchroom"===a&&await integrationsModule.doAfterNodeAppear("[class*=team-table]",async e=>{const a=createBanner();let s=e.querySelector("[class*='forecast-banner']");s&&s.remove(),preppendTo(a,e)})},async()=>{});let previousUrl="",previousLobby=null;const lobbyModules=[{pages:["*"],module:serviceModule,isEnabled:null,isEnabledByDefault:!0},{pages:["*"],module:integrationsModule,isEnabled:null,isEnabledByDefault:!0},{pages:["*"],module:newLevelsModule,isEnabled:null,isEnabledByDefault:!0},{pages:["*"],module:logoSidebarModule,isEnabled:null,isEnabledByDefault:!0},{pages:["stats"],module:rankingModule,isEnabled:null,isEnabledByDefault:!0},{pages:["matchroom"],module:matchRoomModule,isEnabled:null,isEnabledByDefault:!0},{pages:["matchroom"],module:posCatcherModule,isEnabled:null,isEnabledByDefault:!0},{pages:["history","profile"],module:matchHistoryModule,isEnabled:null,isEnabledByDefault:!0}];initExtension().catch(e=>{e("Failed to initialize extension:",e)});